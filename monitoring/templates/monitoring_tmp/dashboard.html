{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
    <!-- Navigation Bar -->
    <nav class="bg-gray-800 p-4 shadow-lg">
        <div class="container mx-auto flex justify-between">
            <h1 class="text-xl font-bold">Network Monitoring Dashboard</h1>
            <div>
                <a href="{% url 'device-monitoring' %}" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded">Device Monitoring</a>
                <a href="{% url 'alert-list' %}" class="ml-4 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded">Alerts</a>
            </div>
        </div>
    </nav>
    <div class="container mx-auto p-6">
        <!-- Bandwidth Usage and Latency -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold">Bandwidth Usage (MB)</h2>
                <canvas id="bandwidthChart" width="300" height="200"></canvas>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold">Latency Trends (ms)</h2>
                <canvas id="latencyChart" width="300" height="200"></canvas>
            </div>
        </div>

        <!-- Packet Loss and Network Health Status -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Packet Loss Visualization -->
            <!-- Packet Loss Distribution -->
<div class="bg-gray-800 p-4 rounded-lg shadow-md">
    <h2 class="text-lg font-semibold">Packet Loss Distribution</h2>
    <div class="text-center mt-4 w-80 h-80 mx-auto"> <!-- Set specific width and height for the container -->
        <canvas id="packetLossChart"></canvas> <!-- Chart will resize according to the container size -->
        <div class="text-sm mt-4">
            <span class="text-green-400">0-5%: </span><span id="loss0to5">0</span> devices |
            <span class="text-yellow-400">5-10%: </span><span id="loss5to10">0</span> devices |
            <span class="text-red-400">10-20%: </span><span id="loss10to20">0</span> devices |
            <span class="text-purple-400">>20%: </span><span id="lossAbove20">0</span> devices
        </div>
    </div>
</div>

            <!-- Network Health Status Line Chart -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold">Network Health Status</h2>
                <div class="text-center mt-4">
                    <canvas id="networkHealthChart" width="300" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_DEVICES = "http://127.0.0.1:8000/api/devices/";

        async function fetchData() {
            try {
                const devicesRes = await fetch(API_DEVICES);
                const devices = await devicesRes.json();

                // Data Preparation
                const deviceNames = devices.map(device => device.name);
                const packetLossData = devices.map(device => device.metrics.length > 0 ? device.metrics[0].packet_loss : 0);
                const bandwidthData = devices.map(device => device.metrics.length > 0 ? device.metrics[0].bandwidth_usage : 0);
                const latencyData = devices.map(device => device.metrics.length > 0 ? device.metrics[0].latency : 0);

                // Bandwidth Chart
                const bandwidthCtx = document.getElementById("bandwidthChart").getContext("2d");
                new Chart(bandwidthCtx, {
                    type: "bar",
                    data: {
                        labels: deviceNames,
                        datasets: [{
                            label: "Bandwidth Usage (MB)",
                            data: bandwidthData,
                            backgroundColor: "rgba(75, 192, 192, 0.5)",
                            borderColor: "rgba(75, 192, 192, 1)",
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });

                // Latency Trends Chart
                const latencyCtx = document.getElementById("latencyChart").getContext("2d");
                new Chart(latencyCtx, {
                    type: "line",
                    data: {
                        labels: deviceNames,
                        datasets: [{
                            label: "Latency (ms)",
                            data: latencyData,
                            backgroundColor: "rgba(255, 99, 132, 0.2)",
                            borderColor: "rgba(255, 99, 132, 1)",
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });

                // Packet Loss Distribution - Doughnut Chart
                const packetLossCtx = document.getElementById("packetLossChart").getContext("2d");
                const lossCategories = {
                    '0-5%': 0,
                    '5-10%': 0,
                    '10-20%': 0,
                    '>20%': 0
                };
                packetLossData.forEach(loss => {
                    if (loss <= 5) lossCategories['0-5%']++;
                    else if (loss <= 10) lossCategories['5-10%']++;
                    else if (loss <= 20) lossCategories['10-20%']++;
                    else lossCategories['>20%']++;
                });

                // Update device count labels
                document.getElementById("loss0to5").innerText = lossCategories['0-5%'];
                document.getElementById("loss5to10").innerText = lossCategories['5-10%'];
                document.getElementById("loss10to20").innerText = lossCategories['10-20%'];
                document.getElementById("lossAbove20").innerText = lossCategories['>20%'];

                new Chart(packetLossCtx, {
                    type: "doughnut",
                    data: {
                        labels: ['0-5%', '5-10%', '10-20%', '>20%'],
                        datasets: [{
                            data: Object.values(lossCategories),
                            backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6f42c1'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(tooltipItem) {
                                        return `${tooltipItem.label}: ${tooltipItem.raw} devices`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Normalize data for Health Score
                const maxBandwidth = Math.max(...bandwidthData);
                const maxLatency = Math.max(...latencyData);
                const maxPacketLoss = Math.max(...packetLossData);

                const normalizedBandwidth = bandwidthData.map(bw => bw / maxBandwidth);
                const normalizedLatency = latencyData.map(lat => lat / maxLatency);
                const normalizedPacketLoss = packetLossData.map(pl => pl / maxPacketLoss);

                // Calculate Health Score
                const healthScores = normalizedBandwidth.map((bw, index) => {
                    const latency = normalizedLatency[index];
                    const packetLoss = normalizedPacketLoss[index];
                    return (1 - bw + 1 - latency + 1 - packetLoss) / 3;  // Average of normalized metrics
                });

                // Network Health Status Line Chart
                const healthCtx = document.getElementById("networkHealthChart").getContext("2d");
                new Chart(healthCtx, {
                    type: "line",
                    data: {
                        labels: deviceNames,
                        datasets: [{
                            label: "Network Health Score",
                            data: healthScores,
                            backgroundColor: "rgba(75, 192, 192, 0.2)",
                            borderColor: "rgba(75, 192, 192, 1)",
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1, // Health score ranges from 0 to 1
                                ticks: {
                                    callback: function(value) {
                                        return value * 100 + "%";
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error("Error fetching data: ", error);
            }
        }

        // Call the fetchData function
        fetchData();
    </script>
</body>
</html>
